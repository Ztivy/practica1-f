<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Ventas AWS</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* --- Reset básico --- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #e9ecef;
            font-family: Arial, Helvetica, sans-serif;
            padding: 20px;
        }

        .wrapper {
            max-width: 1400px;
            margin: auto;
        }

        header {
            text-align: center;
            margin-bottom: 25px;
        }

        header h1 {
            font-size: 2.3rem;
            font-weight: bold;
            color: #303030;
        }

        header p {
            color: #555;
            margin-top: 5px;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(420px, 1fr));
            gap: 20px;
        }

        .panel {
            background: #fff;
            border: 1px solid #d3d3d3;
            border-radius: 6px;
            padding: 18px;
        }

        .panel h2 {
            font-size: 1.2rem;
            margin-bottom: 10px;
            color: #333;
            font-weight: 600;
        }

        canvas {
            width: 100% !important;
            max-height: 360px;
        }

        .loading-box {
            text-align: center;
            margin: 80px 0;
            color: #444;
        }

        .spinner {
            border: 4px solid #ccc;
            border-top: 4px solid #444;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            margin: auto;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error-box {
            background: #ffdddd;
            border-left: 5px solid #cc0000;
            padding: 15px;
            margin-bottom: 30px;
            border-radius: 4px;
            color: #700;
        }

        .selector {
            background: #f1f1f1;
            padding: 12px;
            border-radius: 5px;
            text-align: center;
            margin-bottom: 15px;
        }

        .selector select {
            padding: 8px 14px;
            border-radius: 4px;
            border: 1px solid #888;
            background: white;
            cursor: pointer;
        }

        footer {
            margin-top: 35px;
            text-align: center;
            color: #666;
            font-size: 0.9rem;
        }

        @media (max-width: 600px) {
            header h1 { font-size: 1.8rem; }
        }
    </style>
</head>
<body>

<div class="wrapper">

    <header>
        <h1>Dashboard de Análisis de Ventas</h1>
        <p>Sistema BI sobre AWS Cloud</p>
    </header>

    <div id="loading" class="loading-box">
        <div class="spinner"></div>
        <p>Cargando datos...</p>
    </div>

    <div id="error" class="error-box" style="display:none;">
        <strong>Error:</strong> <span id="error-message"></span>
    </div>

    <div id="charts" class="grid" style="display:none;">
        
        <div class="panel">
            <h2>Ventas Totales por Categoría</h2>
            <canvas id="salesByCategory"></canvas>
        </div>

        <div class="panel">
            <h2>Margen de Ganancia Promedio</h2>
            <canvas id="profitMargin"></canvas>
        </div>

        <div class="panel">
            <h2>Cantidad Vendida por Región</h2>
            <canvas id="quantityByRegion"></canvas>
        </div>

        <div class="panel" style="grid-column: 1 / -1;">
            <h2>Top 5 Productos Más Vendidos</h2>

            <div class="selector">
                <label>Región:</label>
                <select id="regionSelect" onchange="updateTopProducts()">
                    <option value="all">Global</option>
                </select>
            </div>

            <canvas id="topProducts"></canvas>
        </div>
    </div>

    <footer>
        Dashboard desarrollado con AWS Lambda · DynamoDB · API Gateway
        <br>Instituto Tecnológico de Celaya – Big Data
    </footer>

</div>

<script>
/* ============================
   ENDPOINTS DIRECTOS
============================ */
const ENDPOINTS = {
    salesByCategory: "https://8ob9jz0ttd.execute-api.us-east-1.amazonaws.com/default/getSalesByCategory",
    profitMargin: "https://mgf6g7e2m0.execute-api.us-east-1.amazonaws.com/default/getProfitMarginByCategory",
    quantityByRegion: "https://mm779wdd40.execute-api.us-east-1.amazonaws.com/default/getQuantityByRegion",
    topProducts: "https://dnqztv96la.execute-api.us-east-1.amazonaws.com/default/getTopProductsByRegion"
};

let charts = {};
let allTopProductsData = [];

/* ============================
   UTILIDADES
============================ */
function showError(msg) {
    document.getElementById("loading").style.display = "none";
    document.getElementById("error").style.display = "block";
    document.getElementById("error-message").textContent = msg;
}

function hideLoading() {
    document.getElementById("loading").style.display = "none";
    document.getElementById("charts").style.display = "grid";
}

async function fetchData(url) {
    const res = await fetch(url);

    if (!res.ok) {
        throw new Error(`Error HTTP ${res.status}`);
    }

    return await res.json();
}

/* ============================
   GRÁFICO 1 - VENTAS POR CATEGORÍA
============================ */
async function loadAndCreateSalesByCategoryChart() {
    const data = await fetchData(ENDPOINTS.salesByCategory);

    const categories = data.map(i => i.category);
    const sales = data.map(i => i.total_sales);

    charts.salesByCategory = new Chart(
        document.getElementById("salesByCategory"),
        {
            type: "bar",
            data: {
                labels: categories,
                datasets: [{
                    label: "Ventas",
                    data: sales,
                    backgroundColor: "rgba(102,126,234,0.8)"
                }]
            }
        }
    );
}

/* ============================
   GRÁFICO 2 - MARGEN
============================ */
async function loadAndCreateProfitMarginChart() {
    const data = await fetchData(ENDPOINTS.profitMargin);

    const categories = data.map(i => i.category);
    const margins = data.map(i => i.avg_profit_margin_percent);

    charts.profitMargin = new Chart(
        document.getElementById("profitMargin"),
        {
            type: "bar",
            data: {
                labels: categories,
                datasets: [{
                    label: "Margen (%)",
                    data: margins,
                    backgroundColor: "rgba(75,192,192,0.8)"
                }]
            }
        }
    );
}

/* ============================
   GRÁFICO 3 - CANTIDAD POR REGIÓN
============================ */
async function loadAndCreateQuantityByRegionChart() {
    const data = await fetchData(ENDPOINTS.quantityByRegion);

    const regions = data.map(i => i.region);
    const quantities = data.map(i => i.total_quantity);

    charts.quantityByRegion = new Chart(
        document.getElementById("quantityByRegion"),
        {
            type: "bar",
            data: {
                labels: regions,
                datasets: [{
                    label: "Cantidad",
                    data: quantities,
                    backgroundColor: "rgba(255,159,64,0.8)"
                }]
            },
            options: { indexAxis: "y" }
        }
    );
}

/* ============================
   TOP PRODUCTS
============================ */
async function loadTopProductsData() {
    allTopProductsData = await fetchData(ENDPOINTS.topProducts);

    // Extraer regiones únicas
    const regiones = [...new Set(allTopProductsData.map(i => i.region))];

    const selector = document.getElementById("regionSelect");
    regiones.forEach(r => {
        const op = document.createElement("option");
        op.value = r;
        op.textContent = r;
        selector.appendChild(op);
    });

    createTopProductsChart(allTopProductsData);
}

function createTopProductsChart(lista) {
    if (charts.topProducts) charts.topProducts.destroy();

    const top = lista.slice(0, 5);

    charts.topProducts = new Chart(
        document.getElementById("topProducts"),
        {
            type: "bar",
            data: {
                labels: top.map(i => i.product_name),
                datasets: [{
                    label: "Cantidad vendida",
                    data: top.map(i => i.total_quantity),
                    backgroundColor: "rgba(54,162,235,0.8)"
                }]
            }
        }
    );
}

function updateTopProducts() {
    const region = document.getElementById("regionSelect").value;

    const datosFiltrados =
        region === "all"
            ? allTopProductsData
            : allTopProductsData.filter(i => i.region === region);

    createTopProductsChart(datosFiltrados);
}

/* ============================
   INIT
============================ */
async function initDashboard() {
    try {
        await Promise.all([
            loadAndCreateSalesByCategoryChart(),
            loadAndCreateProfitMarginChart(),
            loadAndCreateQuantityByRegionChart(),
            loadTopProductsData()
        ]);

        hideLoading();
    } catch (e) {
        showError(e.message);
    }
}

window.onload = initDashboard;

</script>
</body>
</html>
